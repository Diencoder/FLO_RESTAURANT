<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{layout/header}"></head>
<body>
<div class="container mt-5">
    <h1>Your Cart</h1>

    <table class="table table-bordered">
        <thead>
        <tr>
            <th>Name</th>
            <th>Quantity</th>
            <th>Price</th>
            <th>Total</th>
            <th>Action</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="item : ${cart.items}">
            <td th:text="${item.food.title}"></td>
            <td>
                <!-- Input for changing quantity -->
                <input type="number" th:value="${item.quantity}" name="quantity" class="form-control" min="1" required
                       th:attr="onchange='updateCart(${item.food.id}, this.value)'">

            </td>
            <td th:text="${item.food.price}"></td>
            <td th:text="${item.getTotalPrice()}"></td>
            <td>
                <form th:action="@{/removeFromCart}" method="post">
                    <input type="hidden" name="foodId" th:value="${item.food.id}">
                    <button type="submit" class="btn btn-danger">Remove</button>
                </form>
            </td>
        </tr>
        </tbody>
    </table>

    <p id="totalAmount" th:text="'Total: ' + ${totalAmount}"></p>

    <h3>Th√¥ng tin kh√°ch h√†ng</h3>
    <form th:action="@{/purchase}" method="post">
        <!-- T·∫°o m√£ giao d·ªãch ng·∫´u nhi√™n v·ªõi 6 ch·ªØ s·ªë -->
        <input type="text" name="tran_id" th:value="${T(java.lang.Math).random() * 1000000}" class="form-control" placeholder="M√£ giao d·ªãch" readonly required>

        <!-- T·ª± ƒë·ªông ƒëi·ªÅn th√¥ng tin ng∆∞·ªùi d√πng t·ª´ session -->
        <input type="text" name="username" th:value="${session.username}" class="form-control" placeholder="T√™n ƒëƒÉng nh·∫≠p" readonly required>
        <input type="text" name="cus_name" th:value="${session.cus_name}" class="form-control" placeholder="T√™n kh√°ch h√†ng" required>
        <input type="email" name="cus_email" th:value="${session.cus_email}" class="form-control" placeholder="Email" required>
        <input type="text" name="cus_add1" th:value="${session.cus_add1}" class="form-control" placeholder="ƒê·ªãa ch·ªâ" required>
        <input type="text" name="cus_city" th:value="${session.cus_city}" class="form-control" placeholder="Th√†nh ph·ªë" required>
        <input type="text" name="cus_phone" th:value="${session.cus_phone}" class="form-control" placeholder="S·ªë ƒëi·ªán tho·∫°i" required>

        <br><br>
        <button type="submit" class="btn btn-success">üõí Thanh To√°n</button>
    </form>
</div>

<!-- Th√™m Bootstrap JS -->
<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // Function to update cart when quantity is changed
    function updateCart(foodId, quantity) {
        // Send the updated quantity to the server via AJAX
        fetch(`/updateCart?foodId=${foodId}&quantity=${quantity}`, {
            method: 'POST',
        })
            .then(response => response.json())
            .then(data => {
                // Update the displayed total amount
                document.getElementById('totalAmount').innerText = 'Total: ' + data.totalAmount;

                // Optionally, you could update the quantity and total in the table dynamically here
            })
            .catch(error => {
                console.error('Error updating cart:', error);
            });
    }
</script>

<div th:replace="~{layout/footer}"></div>
</body>
</html>
